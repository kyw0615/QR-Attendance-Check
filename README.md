## 실시간 QR 출석 시스템

Node.js + Express + 브라우저 JS로 만든 **지연 시간 기반 QR 출석 시스템**입니다.  
QR 생성기(`/generator`)에서 **교수 브라우저에서 직접 AES-256-GCM으로 암호화된 토큰**을 만들고, 학생 스캐너(`/attend`)가 찍은 결과를 서버를 거쳐 다시 생성기로 돌려보내 **통계 기반 이상치 탐지로 의심률을 계산**합니다.

---

### 1. 어떻게 돌아가는지

- **`/generator` (교수)**: 
  - 브라우저에서 **세션별 32바이트 랜덤 키를 생성**하여 AES-256-GCM으로 토큰 암호화
  - 암호화된 QR 코드를 화면에 표시 (흰색 배경, 검은색 QR 코드로 최적화)
  - `/api/attend-log`를 폴링해서 학생 로그를 받고 **통계 기반 이상치 탐지**로 의심률 계산
  - 같은 학번은 하나의 행으로 집계하여 인식 횟수, 평균/최소/최대 지연, 의심률 표시
- **`/attend` (학생)**: 휴대폰 카메라로 QR 스캔 → 인식된 암호문(`cipher`)과 `studentId`를 `POST /api/qr`로 전송.
- **`server.js` (서버)**: `POST /api/qr` 요청마다 `studentId + cipher + serverRecvTs`를 메모리에 저장 → `GET /api/attend-log`로 그대로 돌려줌. **서버는 암호화 키를 모르며 단순히 운반/저장만 수행**.

---

### 2. 실행 방법

```bash
cd "/Users/kimyougwoo/융보프2/qr code"
npm install       # 최초 1회
npm start         # 서버 실행 (기본 포트 3000)
```

- 접속 URL:
  - `http://localhost:3000/` → 인덱스
  - `http://localhost:3000/generator` → QR 생성(교수용)
  - `http://localhost:3000/attend` → 출석 스캔(학생용)

---

### 3. iPhone / HTTPS 테스트 (ngrok)

- iOS Safari에서 카메라를 쓰려면 **HTTPS**가 필요합니다.
- `NGROK_SETUP.md` 참고 (요약: `npm install -g ngrok` → `ngrok config add-authtoken ...` → `npm run dev:ngrok` → `https://...ngrok-free.app` 로 접속).

---

### 4. 주요 기능

- **암호화**: 교수 브라우저에서 세션별 랜덤 키로 AES-256-GCM 암호화. 서버는 키를 모르며 단순 운반만 수행.
- **QR 인식 최적화**: 흰색 배경과 검은색 QR 코드로 인식률 개선. 매번 새 QRCode 인스턴스 생성으로 안정성 향상.
- **학번별 통계 집계**: 같은 학번은 하나의 행으로 집계하여 다음 정보를 표시:
  - 인식 횟수
  - 평균 지연 시간 (ms)
  - 최소 지연 시간 (ms)
  - 최대 지연 시간 (ms)
  - 의심률 (%)
- **통계 기반 이상치 탐지**: 
  - 모든 학생의 평균 지연시간의 평균을 계산
  - 표준편차 2배 이상 벗어난 학생을 제외하고 강건한 평균 재계산
  - Z-score 기반으로 상대적 편차에 따라 의심률 계산 (0-100%)
  - 네트워크 환경에 따라 자동으로 기준 조정
- **FPS 조절**: `/generator`에서 목표 FPS(15/30/60)를 선택해 QR 갱신 속도와 delta 분포 변화를 실험 가능.

### 5. 보안 모델

- **교수 브라우저**: 세션 키 생성 및 암호화/복호화 수행. 키는 브라우저 메모리에만 존재.
- **서버**: 암호화 키를 모르며, cipher 문자열을 단순히 저장/전달만 수행.
- **학생**: QR에서 읽은 암호문을 그대로 서버에 전송. 복호화 불가능.

