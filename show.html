<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Fast QR (설정 후 시작)</title>
<style>
  body { font-family: system-ui, sans-serif; margin: 24px; }
  #q { width: 256px; height: 256px; overflow: hidden; }
  .row { display:flex; gap:24px; align-items:center; flex-wrap:wrap; }
  label { display:block; font-size:14px; color:#555; }
  input, select, button { font-family: inherit; }
</style>
</head>
<body>
  <h1>Fast QR (설정 후 시작)</h1>
  <div class="row">
    <div id="q"></div>
    <div>
      <label>FPS: <input id="fpsInput" type="number" min="1" max="60" value="30" style="width:5em"/> (<span id="ms">33</span> ms)</label>
      <label>버전(1~40): <input id="ver" type="number" min="1" max="40" value="5" style="width:4em"/></label>
      <label>스케일(px/module): <input id="scale" type="number" min="2" max="12" value="6" style="width:4em"/></label>
      <label>오류정정(ECC):
        <select id="eccSel">
          <option value="L" selected>L</option>
          <option value="M">M</option>
          <option value="Q">Q</option>
          <option value="H">H</option>
        </select>
      </label>
      <div style="margin-top:8px">
        <button id="startBtn">▶ 생성 시작</button>
        <button id="stopBtn" disabled>⏸︎ 정지</button>
      </div>
      <div id="info" style="margin-top:8px; font-size:12px; color:#666"></div>
    </div>
  </div>

  <!-- qrcode.js: 가볍고 캔버스 렌더링 -->
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
  <script>
  // === 설정 ===
  let ecc = 'L';
  let version = 5;
  let scale = 6;
  let targetFPS = 30;
  let running = false;

  const $q = document.getElementById('q');
  const $fpsInput = document.getElementById('fpsInput');
  const $ms = document.getElementById('ms');
  const $ver = document.getElementById('ver');
  const $scale = document.getElementById('scale');
  const $eccSel = document.getElementById('eccSel');
  const $startBtn = document.getElementById('startBtn');
  const $stopBtn = document.getElementById('stopBtn');
  const $info = document.getElementById('info');

  // 초기 QR 인스턴스(더미)
  let qr = new QRCode($q, {
    text: "TS=" + Date.now(),
    width: 256, height: 256,
    colorDark : "#000000", colorLight : "#ffffff",
    correctLevel : QRCode.CorrectLevel.L
  });

  // TS 전용 토큰
  async function makeToken(){
    return `TS=${Date.now()}`;
  }

  // 렌더 루프
  let lastRender = 0;
  let lastTick = -1;
  async function loop(now) {
    const frameMs = 1000 / targetFPS;
    if (!running) { requestAnimationFrame(loop); return; }
    if (now - lastRender >= frameMs) {
      lastRender = now;
      const tick = Math.floor(now / frameMs);
      if (tick !== lastTick) {
        lastTick = tick;
        const t0 = performance.now();
        const token = await makeToken();
        // qrcode.js는 옵션 변경 시 새로 생성하는 방식이 단순/안정적
        $q.innerHTML = "";
        const levelMap = QRCode.CorrectLevel;
        const level = levelMap[ecc] ?? levelMap.M;
        // QR 표시 크기를 고정(버전에 무관하게 UI를 가리지 않도록)
        const qrSizePx = 256; // 필요 시 320 등으로 조정 가능
        qr = new QRCode($q, {
          text: token,
          width: qrSizePx,
          height: qrSizePx,
          colorDark : "#000000",
          colorLight : "#ffffff",
          correctLevel : level
        });
        // === Add random brightness noise to QR canvas ===
        const canvas = $q.querySelector('canvas');
        if (canvas) {
          const ctx = canvas.getContext('2d');
          const imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
          const data = imgData.data;
          const noiseBlockSize = 10; // adjust cluster size of noise
          for (let y = 0; y < canvas.height; y += noiseBlockSize) {
            for (let x = 0; x < canvas.width; x += noiseBlockSize) {
              const noise = (Math.random() - 0.5) * 200; // smaller amplitude
              for (let dy = 0; dy < noiseBlockSize; dy++) {
                for (let dx = 0; dx < noiseBlockSize; dx++) {
                  const nx = x + dx;
                  const ny = y + dy;
                  if (nx < canvas.width && ny < canvas.height) {
                    const idx = (ny * canvas.width + nx) * 4;
                    data[idx] = Math.min(255, Math.max(0, data[idx] + noise));
                    data[idx+1] = Math.min(255, Math.max(0, data[idx+1] + noise));
                    data[idx+2] = Math.min(255, Math.max(0, data[idx+2] + noise));
                  }
                }
              }
            }
          }
          ctx.putImageData(imgData, 0, 0);
        }
        const t1 = performance.now();
        $info.textContent = `v=${version} ecc=${ecc} fps=${targetFPS} tokenLen=${token.length} render ${(t1 - t0).toFixed(1)} ms`;
      }
    }
    requestAnimationFrame(loop);
  }

  // UI 바인딩 (설정 확정 후 시작)
  $fpsInput.addEventListener('change', () => {
    targetFPS = Math.max(1, Math.min(60, parseInt($fpsInput.value||"30", 10)));
    $ms.textContent = Math.round(1000/targetFPS);
  });
  $ver.addEventListener('change', () => {
    version = Math.max(1, Math.min(40, parseInt($ver.value||"5", 10)));
  });
  $scale.addEventListener('change', () => {
    scale = Math.max(2, Math.min(12, parseInt($scale.value||"6", 10)));
  });
  $eccSel.addEventListener('change', () => {
    ecc = String($eccSel.value||'L').toUpperCase();
  });
  $startBtn.addEventListener('click', () => {
    targetFPS = Math.max(1, Math.min(60, parseInt($fpsInput.value||"30", 10)));
    version = Math.max(1, Math.min(40, parseInt($ver.value||"5", 10)));
    scale = Math.max(2, Math.min(12, parseInt($scale.value||"6", 10)));
    ecc = String($eccSel.value||'L').toUpperCase();
    $ms.textContent = Math.round(1000/targetFPS);
    running = true;
    $startBtn.disabled = true;
    $stopBtn.disabled = false;
  });
  $stopBtn.addEventListener('click', () => {
    running = false;
    $startBtn.disabled = false;
    $stopBtn.disabled = true;
  });

  // 루프 준비(수동 시작)
  requestAnimationFrame(loop);
  </script>
</body>
</html>